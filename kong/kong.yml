_format_version: "3.0"
_transform: true

# JWT Consumer with Keycloak Public Key
consumers:
  - username: keycloak-issuer
    jwt_secrets:
      - key: "http://13.229.125.83:8080/realms/demo"
        algorithm: RS256
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAo345FSlAYmBx7jiMnLNCY7o2MD8rSjxLz4oCmu9DDm7E17yd2UJx3DKGsaMgfOA8r6qBqKWea+r2DtscW95JZDH28x/vV0/Spoic/uNn9lH4MxQeLswi+JjcgVdhu8XntF2NaX/iThUoi9yr4jGb12gUBW3IiLzKNtHeo9nTiYiwTH5N6mBTVJ/VIVFYz/1Zn+tqlDvOAH/fvP11qLii503SCIFoeK8QUp2glDjwcFwcNHgy8U+qqvC3DlzsRnmwbybBI+6uDGSGk3rJ6y7LtFQxsiO8YXoS/U2xXSN21K1NOy9xrl82fCxFbhk8gvtehrcw1+KR/1OO6DtSdoOdNQIDAQAB
          -----END PUBLIC KEY-----

# Global Plugins
plugins:
  - name: http-log
    config:
      http_endpoint: "http://13.229.125.83:8081/kong"
      method: POST
      timeout: 10000
      keepalive: 60000
      queue:
        max_batch_size: 10
        max_retry_time: 60
        max_coalescing_delay: 5

services:
  # Login Service - Public endpoint
  - name: auth-service
    url: http://13.229.125.83:3000
    routes:
      - name: auth-route
        paths: ["/auth/login"]
        strip_path: false
        methods: ["POST"]
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  local body, err = kong.request.get_body()
                  if err or not body then
                    return kong.response.exit(400, { message = "Payload must be valid JSON. " .. (err or "") })
                  end
                  if type(body.username) ~= "string" or type(body.password) ~= "string" then
                    return kong.response.exit(400, { message = "Username and password must be strings" })
                  end
                  local username_len = #body.username
                  local password_len = #body.password
                  if username_len < 3 or username_len > 50 or password_len < 6 or password_len > 100 then
                    return kong.response.exit(400, { message = "Invalid credential format" })
                  end
          - name: rate-limiting
            config:
              second: 5
              minute: 60
              policy: local
              fault_tolerant: true
              hide_client_headers: false
          - name: request-size-limiting
            config:
              allowed_payload_size: 128

  # Protected API Service - Requires JWT Authentication
  - name: user-service
    url: http://13.229.125.83:3000
    routes:
      - name: user-route
        paths: ["/api"]
        strip_path: false
        methods: ["GET", "POST", "PUT", "DELETE"]
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              claims_to_verify: [exp]
              run_on_preflight: true
              maximum_expiration: 3600
          - name: rate-limiting
            config:
              minute: 100
              policy: local
              fault_tolerant: true
