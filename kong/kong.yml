_format_version: "3.0"
_transform: true

# JWT Consumer with Keycloak Public Key
consumers:
  - username: keycloak-issuer
    jwt_secrets:
      - key: "http://13.213.32.80:8080/realms/demo"
        algorithm: RS256
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuOyb0AxGJYxvlRX46bG+cXtV81UyOxFbl9DInWyVGHBME36z7EZjCICyBqAdfliWTp8Qi/7PiHwhDyN6EWfSl/E5To30uUfjKWL8Bkur1bYYnGI0SmA/TA//rRnQM4ypaH5mvvtEEQHZkczEYQFrA8m3ysNK6KEL7Ol5QwNg8wnh/0SZofBg/jHrNi45YeeTGpNvtc60SrOgIItKIQV0JYfLvNHodnftGv0GrZn8RCqP9eGIBClg/Uog7iLiFckTl+ppbFZEdAj22twls/xMwzZB6ypzi1Jc75UJd0mL+vjHEtdrv8gt6uItBd+4J/omAZCMlEGssVq68O71ABY9cwIDAQAB
          -----END PUBLIC KEY-----

# Global Plugins
plugins:
  - name: http-log
    config:
      # Gửi log nội bộ qua Logstash service trong docker-compose
      http_endpoint: "http://logstash:8081/kong"
      method: POST
      timeout: 10000
      keepalive: 60000
      queue:
        max_batch_size: 10
        max_retry_time: 60
        max_coalescing_delay: 5

services:
  # Login Service - Public endpoint
  - name: auth-service
    url: http://13.213.32.80:3000
    routes:
      - name: auth-route
        paths: ["/auth/login"]
        strip_path: false
        methods: ["POST"]
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  local body, err = kong.request.get_body()
                  if err or not body then
                    return kong.response.exit(400, { message = "Payload must be valid JSON. " .. (err or "") })
                  end
                  if type(body.username) ~= "string" or type(body.password) ~= "string" then
                    return kong.response.exit(400, { message = "Username and password must be strings" })
                  end
                  local username_len = #body.username
                  local password_len = #body.password
                  if username_len < 3 or username_len > 50 or password_len < 6 or password_len > 100 then
                    return kong.response.exit(400, { message = "Invalid credential format" })
                  end
          - name: rate-limiting
            config:
              second: 5
              minute: 60
              policy: local
              fault_tolerant: true
              hide_client_headers: false
          - name: request-size-limiting
            config:
              allowed_payload_size: 128

  # Protected API Service - Requires JWT Authentication
  - name: user-service
    url: http://13.213.32.80:3000
    routes:
      - name: user-route
        paths: ["/api"]
        strip_path: false
        methods: ["GET", "POST", "PUT", "DELETE"]
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              claims_to_verify: [exp]
              run_on_preflight: true
              maximum_expiration: 3600
          - name: rate-limiting
            config:
              minute: 100
              policy: local
              fault_tolerant: true
