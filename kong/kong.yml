_format_version: "3.0"
_transform: true

# JWT Consumer with Keycloak Public Key
consumers:
  - username: keycloak-issuer
    jwt_secrets:
      - key: "http://18.139.209.233:8080/realms/demo"
        algorithm: RS256
        rsa_public_key: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1jwe+ekZAKnXUtvlgHITrIXJYefTyzzOloqLWzD23Yd/bPpaPvKApyQvnTub8tXd/ACG5U3fTItySBp+2RY/tNW1YKZw7TTVdyWCt0qyJVGxUpCEC/KassxpR/LF8Js25+w7Z4bqzfFTfsJzKUFOFOgNMDD4vJKDEgLFMhHwgXjsVLXVy1P9vNDyLXmde+IT5GvHMTK+SWZT8XgPytai6xf7UdA+pAz91s0soILJFKXFsbUD9u4roIC2OD/XFHYxLRzpRLpcSWutOJQZbcc//kt24AaBGT8+L/AuVNRW/miBODTZSihl3Np7JsHK/1Q+r2uZQtGiapackN0iV+yP1wIDAQAB
          -----END PUBLIC KEY-----

# Global Plugins
plugins:
  - name: http-log
    config:
      http_endpoint: "http://18.139.209.233:8081/kong"
      method: POST
      timeout: 10000
      keepalive: 60000
      queue:
        max_batch_size: 10
        max_retry_time: 60
        max_coalescing_delay: 5

services:
  # Login Service - Public endpoint
  - name: auth-service
    url: http://18.139.209.233:3000
    routes:
      - name: auth-route
        paths: ["/auth/login"]
        strip_path: false
        methods: ["POST"]
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  local body, err = kong.request.get_body()
                  if err or not body then
                    return kong.response.exit(400, { message = "Payload must be valid JSON. " .. (err or "") })
                  end
                  if type(body.username) ~= "string" or type(body.password) ~= "string" then
                    return kong.response.exit(400, { message = "Username and password must be strings" })
                  end
                  local username_len = #body.username
                  local password_len = #body.password
                  if username_len < 3 or username_len > 50 or password_len < 6 or password_len > 100 then
                    return kong.response.exit(400, { message = "Invalid credential format" })
                  end
          - name: rate-limiting
            config:
              second: 5 # Chặn chặt lượng request cho kẻ tấn công (5 req/s)
              minute: 60
              policy: local
              fault_tolerant: true
              hide_client_headers: false
          - name: request-size-limiting
            config:
              allowed_payload_size: 128

  # Protected API Service - Requires JWT Authentication
  - name: user-service
    url: http://18.139.209.233:3000
    routes:
      - name: user-route
        paths: ["/api"]
        strip_path: false
        methods: ["GET", "POST", "PUT", "DELETE"]
        plugins:
          - name: jwt
            config:
              key_claim_name: iss
              claims_to_verify: [exp]
              run_on_preflight: true
              maximum_expiration: 3600
          - name: rate-limiting
            config:
              minute: 10000 # Mở rộng lượng request cho User thật (10,000 req/phút)
              policy: local
              fault_tolerant: true
